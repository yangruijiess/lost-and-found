# 个人中心页面接口需求分析

## 功能概述

个人中心页面是用户管理个人信息的核心界面。用户可以查看和编辑基本信息、联系方式、隐私设置，并管理头像上传。页面提供了本地存储和后端API两种数据处理模式，确保数据的一致性和安全性。

## 统一配置与命名规范

为确保多页面间的一致性，统一使用以下配置：

1. **API基础URL**：`const API_BASE_URL = '/api';`
2. **用户数据存储键名**：`const USER_DATA_KEY = `user_${CURRENT_USER_ID}`;`
3. **数据字段命名**：
   - 统一使用驼峰命名法
   - 隐私设置使用嵌套对象结构
4. **响应格式规范**：
   ```json
   {
     "success": true/false,
     "data": {...}, // 成功时返回数据
     "error": {"code": 400, "message": "错误信息"} // 失败时返回错误
   }
   ```

## 前端功能与数据需求

### 核心功能
1. **基本信息管理**：查看和编辑用户名、性别、学院等个人资料
2. **联系方式管理**：维护手机号码和电子邮箱等联系信息
3. **隐私设置管理**：配置个人信息的可见性
4. **头像上传功能**：支持用户上传和预览个人头像
5. **选项卡切换**：在不同信息模块间切换查看和编辑

### 数据结构需求

用户数据的结构如下：

```javascript
{
  id: 'user-id',            // 用户唯一标识符
  username: '用户名',        // 用户名
  avatar: 'avatar-url',     // 头像URL
  gender: 'male|female|other', // 性别
  college: '学院',          // 所属学院
  phone: '手机号',          // 手机号码
  email: '电子邮箱',         // 电子邮箱
  wechat: '微信号',         // 微信号（可选）
  address: '地址',          // 地址（可选）
  privacy: {
    showPhone: true,        // 是否公开手机号
    showEmail: false,       // 是否公开邮箱
    showWechat: false,      // 是否公开微信号
    showAddress: false      // 是否公开地址
  },
  createdAt: 'ISO时间'      // 创建时间
}

## 接口需求

### 1. 获取用户信息

**接口路径**：`GET /api/users/:id`

**请求方式**：GET

**请求头**：
- `Authorization`: `Bearer {token}`

**成功响应**：
```json
{
  "success": true,
  "data": {
    "id": "user-id",
    "username": "张三",
    "avatar": "https://example.com/avatars/user123.jpg",
    "gender": "male",
    "college": "计算机学院",
    "phone": "13812345678",
    "email": "zhangsan@example.com",
    "wechat": "zhangsan123",
    "address": "学生宿舍3号楼201",
    "privacy": {
      "showPhone": true,
      "showEmail": false,
      "showWechat": false,
      "showAddress": false
    },
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

### 2. 更新基本信息

**接口路径**：`PUT /api/users/:id/basic`

**请求方式**：PUT

**请求头**：
- `Authorization`: `Bearer {token}`
- `Content-Type`: `application/json`

**请求体**：
```json
{
  "username": "张三",
  "gender": "male",
  "college": "计算机学院"
}
```

**成功响应**：
```json
{
  "success": true,
  "data": {
    "id": "user-id",
    "username": "张三",
    "gender": "male",
    "college": "计算机学院",
    "updatedAt": "2024-03-20T12:00:00Z"
  }
}

### 3. 更新联系方式

**接口路径**：`PUT /api/users/:id/contact`

**请求方式**：PUT

**请求头**：
- `Authorization`: `Bearer {token}`
- `Content-Type`: `application/json`

**请求体**：
```json
{
  "phone": "13812345678",
  "email": "zhangsan@example.com",
  "wechat": "zhangsan123",
  "address": "学生宿舍3号楼201"
}
```

**成功响应**：
```json
{
  "success": true,
  "data": {
    "id": "user-id",
    "phone": "13812345678",
    "email": "zhangsan@example.com",
    "wechat": "zhangsan123",
    "address": "学生宿舍3号楼201",
    "updatedAt": "2024-03-20T12:05:00Z"
  }
}

### 4. 更新隐私设置

**接口路径**：`PUT /api/users/:id/privacy`

**请求方式**：PUT

**请求头**：
- `Authorization`: `Bearer {token}`
- `Content-Type`: `application/json`

**请求体**：
```json
{
  "showPhone": true,
  "showEmail": false,
  "showWechat": false,
  "showAddress": false
}
```

**成功响应**：
```json
{
  "success": true,
  "data": {
    "id": "user-id",
    "privacy": {
      "showPhone": true,
      "showEmail": false,
      "showWechat": false,
      "showAddress": false
    },
    "updatedAt": "2024-03-20T12:10:00Z"
  }
}
```

### 5. 上传头像

**接口路径**：`POST /api/users/:id/avatar`

**请求方式**：POST

**请求头**：
- `Authorization`: `Bearer {token}`

**请求体**：multipart/form-data
- `avatar`: 头像图片文件

**成功响应**：
```json
{
  "success": true,
  "data": {
    "id": "user-id",
    "avatar": "https://example.com/avatars/user123_new.jpg",
    "updatedAt": "2024-03-20T12:15:00Z"
  }
}
```

### 3.4 获取用户统计数据接口

**接口路径**：`/api/users/:userId/stats`
**请求方法**：`GET`
**请求参数**：
- `userId` (路径参数)：用户ID

**响应数据**：
```json
{
  "posts": number,
  "recovered": number,
  "favorites": number,
  "joinedDays": number,
  "recentActivity": [
    {
      "type": "string",
      "description": "string",
      "timestamp": "string"
    }
  ]
}
```

## 4. 数据库设计

### 4.1 用户表 (users)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `id` | `VARCHAR(36)` | `PRIMARY KEY` | 用户ID |
| `username` | `VARCHAR(50)` | `NOT NULL UNIQUE` | 用户名 |
| `nickname` | `VARCHAR(50)` | `NOT NULL` | 昵称 |
| `password_hash` | `VARCHAR(255)` | `NOT NULL` | 哈希后的密码 |
| `gender` | `ENUM('male', 'female', 'other')` | `DEFAULT 'other'` | 性别 |
| `birthday` | `DATE` | `NULL` | 生日 |
| `bio` | `TEXT` | `NULL` | 个人简介 |
| `phone` | `VARCHAR(20)` | `UNIQUE NULL` | 手机号码 |
| `email` | `VARCHAR(100)` | `UNIQUE NULL` | 电子邮箱 |
| `wechat` | `VARCHAR(50)` | `NULL` | 微信 |
| `address` | `TEXT` | `NULL` | 常用地址 |
| `avatar` | `VARCHAR(255)` | `NULL` | 头像URL |
| `role` | `VARCHAR(20)` | `DEFAULT '普通用户'` | 用户角色 |
| `created_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP` | 创建时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 4.2 用户隐私设置表 (user_privacy_settings)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `user_id` | `VARCHAR(36)` | `PRIMARY KEY REFERENCES users(id)` | 用户ID |
| `profile_visibility` | `ENUM('仅自己可见', '已认证用户可见', '所有人可见')` | `DEFAULT '仅自己可见'` | 个人资料可见性 |
| `message_permission` | `ENUM('所有人', '仅已认证用户', '仅关注的用户')` | `DEFAULT '所有人'` | 私信权限 |
| `searchable_posts` | `BOOLEAN` | `DEFAULT TRUE` | 是否允许搜索发布记录 |
| `default_anonymous` | `BOOLEAN` | `DEFAULT FALSE` | 是否默认匿名发布 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

### 4.3 用户统计数据表 (user_stats)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|---------|------|------|
| `user_id` | `VARCHAR(36)` | `PRIMARY KEY REFERENCES users(id)` | 用户ID |
| `posts_count` | `INT` | `DEFAULT 0` | 发布信息数量 |
| `recovered_count` | `INT` | `DEFAULT 0` | 找回物品数量 |
| `favorites_count` | `INT` | `DEFAULT 0` | 收藏数量 |
| `last_activity` | `TIMESTAMP` | `NULL` | 最后活动时间 |
| `updated_at` | `TIMESTAMP` | `DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP` | 更新时间 |

## 5. 后端实现要点

### 5.1 用户认证与授权
- 使用JWT进行身份认证
- 确保用户只能访问和修改自己的信息
- 权限验证确保接口安全性

### 5.2 数据验证
- 实现完善的输入验证机制
- 手机号和邮箱格式验证
- 敏感数据长度和格式限制

### 5.3 文件上传处理
- 支持常见图片格式（JPG、PNG、GIF）
- 图片大小限制（建议不超过5MB）
- 图片处理（压缩、裁剪为合适尺寸）
- 安全存储（防止路径遍历、XSS等攻击）

### 5.4 数据更新策略
- 实现部分更新机制，只更新提供的字段
- 确保数据一致性，尤其是涉及关联表时
- 记录操作日志，便于追踪和审计

### 5.5 性能优化
- 对频繁访问的数据进行缓存
- 优化数据库查询，添加适当索引
- 考虑使用异步处理头像上传等耗时操作

## 6. 前端与后端对接说明

### 6.1 请求头设置
- 所有需要认证的接口请求需添加Authorization头
- 上传文件时设置正确的Content-Type

### 6.2 错误处理
- 前端需处理常见错误码（401认证失败、403权限不足、400参数错误等）
- 提供友好的错误提示给用户
- 实现请求重试机制（针对网络临时故障）

### 6.3 数据同步
- 前端修改数据后立即更新UI状态
- 实现乐观更新策略，提升用户体验
- 保存失败时自动回滚UI状态

## 7. 扩展功能建议

### 7.1 安全增强
- 实现两步验证（2FA）接口
- 添加登录历史记录查询

### 7.2 社交功能
- 关注/粉丝关系管理接口
- 社交账号绑定/解绑接口

### 7.3 数据分析
- 用户行为分析数据接口
- 物品找回率统计接口

### 7.4 通知设置
- 自定义通知偏好设置接口
- 消息推送管理接口

## 8. 总结

本接口设计为个人中心页面提供了完整的数据交互支持，包括用户信息的查询和修改、头像上传、统计数据获取等功能。通过合理的数据模型设计和安全机制，确保用户数据的安全性和完整性。同时，接口设计充分考虑了扩展性，为未来功能迭代提供了基础。