<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物品验证 - 失物招领平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E40AF',
                        secondary: '#3B82F6',
                        accent: '#60A5FA',
                        neutral: '#64748B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary/50;
            }
            .btn-secondary {
                @apply bg-white hover:bg-gray-100 text-gray-700 font-medium border border-gray-300 py-2 px-4 rounded transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-gray-200;
            }
            .input-field {
                @apply w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300;
            }
            .form-label {
                @apply block text-sm font-medium text-gray-700 mb-1;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <button id="backButton" class="text-gray-600 hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold text-primary">物品验证</h1>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6 card-shadow">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-primary mb-4">
                    <i class="fa fa-shield text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">身份验证</h2>
                <p class="text-gray-600 mt-2">请回答关于物品的详细描述以验证您的身份</p>
            </div>

            <form id="verificationForm" class="space-y-4">
                <!-- 隐藏的物品ID和类型 -->
                <input type="hidden" id="itemId" value="">
                <input type="hidden" id="itemType" value="">

                <!-- 验证问题区域 -->
                <div id="verificationQuestions" class="space-y-6">
                    <!-- 问题1：物品颜色 -->
                    <div>
                        <label class="form-label">该物品的颜色是什么？</label>
                        <input type="text" id="colorQuestion" class="input-field" placeholder="请输入物品的颜色" required>
                    </div>

                    <!-- 问题2：物品特征 -->
                    <div>
                        <label class="form-label">该物品有哪些明显的特征或标记？</label>
                        <textarea id="featuresQuestion" class="input-field" rows="3" placeholder="请描述物品的明显特征" required></textarea>
                    </div>

                    <!-- 问题3：发现地点细节 -->
                    <div>
                        <label class="form-label">请描述发现该物品的确切位置细节（如附近的地标、具体区域等）</label>
                        <textarea id="locationDetailsQuestion" class="input-field" rows="3" placeholder="请详细描述发现位置" required></textarea>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="btn-primary w-full">
                        <i class="fa fa-check mr-2"></i>提交验证
                    </button>
                </div>
            </form>

            <div class="text-center mt-6 text-sm text-gray-500">
                <p>此验证步骤用于确保物品能够归还到真正的失主手中</p>
                <p class="mt-1">如有疑问，请联系平台客服</p>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-4 py-6 text-center text-gray-600">
            <p>© 2024 失物招领平台 - 让每一件物品都能找到回家的路</p>
        </div>
    </footer>

    <script>
        // 获取URL参数
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                id: params.get('id'),
                type: params.get('type'),
                imageUrl: params.get('imageUrl')
            };
        }

        // 返回按钮功能
        document.getElementById('backButton').addEventListener('click', function() {
            window.location.href = '失物招领平台_招领页面.html';
        });

        // 调用豆包大语言模型API生成验证问题和答案
        async function generateVerificationContent(imageUrl) {
            // 显示加载状态
            document.getElementById('verificationQuestions').innerHTML = '<p class="text-center text-gray-500">正在生成验证问题，请稍候...</p>';
            
            try {
                // 方式一：直接调用豆包API（前端调用需要处理CORS问题）
                // 注意：实际生产环境中，由于安全和CORS限制，建议通过后端中转调用API
                // const response = await fetch('https://api.doubao.com/v1/chat/completions', {
                //     method: 'POST',
                //     headers: {
                //         'Content-Type': 'application/json',
                //         'Authorization': 'Bearer YOUR_API_KEY' // 请替换为实际的API密钥
                //     },
                //     body: JSON.stringify({
                //         model: 'ERNIE-Bot-4', // 豆包模型名称
                //         messages: [
                //             {
                //                 role: 'system',
                //                 content: '你是一个物品验证助手。请分析提供的图片，并生成3个关于图片内容的验证问题，每个问题必须有明确的关键词答案。输出格式为JSON：{"questions":[{"question":"问题文本","keywords":["关键词1","关键词2"]},{"question":"问题文本2","keywords":["关键词3","关键词4"]},{"question":"问题文本3","keywords":["关键词5","关键词6"]}]}。问题应该聚焦于物品的明显特征，如颜色、形状、标记等。'
                //             },
                //             {
                //                 role: 'user',
                //                 content: `请分析这张图片并生成验证问题：${imageUrl}`
                //             }
                //         ],
                //         max_tokens: 500
                //     })
                // });
                // const data = await response.json();
                // const content = JSON.parse(data.choices[0].message.content);
                
                // 方式二：通过后端API中转调用（推荐生产环境使用）
                const response = await fetch('/api/generate-verification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageUrl: imageUrl
                    })
                });
                
                const data = await response.json();
                return data.verificationContent;
            } catch (error) {
                console.error('生成验证内容失败:', error);
                // 如果API调用失败，使用备用问题
                return {
                    questions: [
                        { question: "该物品的颜色是什么？", keywords: ["红色", "蓝色", "黑色"] },
                        { question: "该物品有哪些明显的特征？", keywords: ["标签", "标志", "图案"] },
                        { question: "物品的大致形状是什么？", keywords: ["圆形", "方形", "长方形"] }
                    ]
                };
            }
        }

        // 渲染验证问题
        function renderVerificationQuestions(questions) {
            const questionsContainer = document.getElementById('verificationQuestions');
            questionsContainer.innerHTML = '';
            
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.innerHTML = `
                    <label class="form-label">${q.question}</label>
                    <textarea 
                        id="question-${index}" 
                        class="input-field" 
                        rows="2" 
                        placeholder="请输入您的回答" 
                        required
                        data-keywords="${JSON.stringify(q.keywords)}">
                    </textarea>
                `;
                questionsContainer.appendChild(questionDiv);
            });
        }

        // 初始化页面
        async function initPage() {
            const params = getUrlParams();
            document.getElementById('itemId').value = params.id || '1';
            document.getElementById('itemType').value = params.type || 'found';
            
            console.log('验证物品ID:', params.id, '类型:', params.type);
            
            // 获取物品图片URL（实际应用中应从服务器获取）
            let imageUrl = params.imageUrl || '';
            
            // 如果没有传入图片URL，尝试从服务器获取
            if (!imageUrl) {
                try {
                    const response = await fetch(`/api/${params.type}-items/${params.id}`);
                    const itemData = await response.json();
                    imageUrl = itemData.images && itemData.images.length > 0 ? itemData.images[0] : '';
                } catch (error) {
                    console.error('获取物品信息失败:', error);
                    // 使用默认图片URL作为示例
                    imageUrl = 'https://example.com/default-item.jpg';
                }
            }
            
            // 生成并渲染验证问题
            try {
                const verificationContent = await generateVerificationContent(imageUrl);
                renderVerificationQuestions(verificationContent.questions);
                // 保存正确答案到localStorage，用于验证
                localStorage.setItem(`verification_${params.id}`, JSON.stringify(verificationContent.questions));
            } catch (error) {
                console.error('初始化验证问题失败:', error);
                alert('生成验证问题失败，请稍后再试。');
                window.location.href = '失物招领平台_招领页面.html';
            }
        }

        // 验证用户回答是否包含关键信息
        function validateAnswer(userAnswer, keywords) {
            // 将用户回答转换为小写进行比较
            const normalizedAnswer = userAnswer.toLowerCase();
            
            // 检查是否包含任意一个关键词
            return keywords.some(keyword => {
                const normalizedKeyword = keyword.toLowerCase();
                return normalizedAnswer.includes(normalizedKeyword);
            });
        }

        // 表单提交处理
        document.getElementById('verificationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const params = getUrlParams();
            const itemId = params.id || '1';
            const itemType = params.type || 'found';
            
            // 从localStorage获取验证问题和答案
            const storedVerification = localStorage.getItem(`verification_${itemId}`);
            if (!storedVerification) {
                alert('验证信息丢失，请重新开始验证流程。');
                window.location.href = '失物招领平台_招领页面.html';
                return;
            }
            
            const verificationQuestions = JSON.parse(storedVerification);
            
            // 收集用户答案并验证
            let allAnswersCorrect = true;
            
            verificationQuestions.forEach((q, index) => {
                const userAnswer = document.getElementById(`question-${index}`).value.trim();
                const isCorrect = validateAnswer(userAnswer, q.keywords);
                
                if (!isCorrect) {
                    allAnswersCorrect = false;
                }
            });
            
            // 全部答案都正确才算验证通过
            if (allAnswersCorrect) {
                // 验证通过，清除localStorage中的验证信息
                localStorage.removeItem(`verification_${itemId}`);
                alert('验证通过！正在跳转到详情页面...');
                window.location.href = `失物招领平台_详情页面.html?id=${itemId}&type=${itemType}`;
            } else {
                // 验证失败
                alert('验证失败！请确保您了解该物品的详细信息。');
                // 可以选择停留在当前页面让用户重新尝试，或者返回招领页面
                // window.location.href = '失物招领平台_招领页面.html';
            }
        });

        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>