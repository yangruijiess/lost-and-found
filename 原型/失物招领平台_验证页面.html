<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物品验证 - 失物招领平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1E40AF',
                        secondary: '#3B82F6',
                        accent: '#60A5FA',
                        neutral: '#64748B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            .btn-primary {
                background-color: var(--primary-color, #4f46e5);
                color: white;
                font-weight: 500;
                padding: 0.5rem 1rem;
                border-radius: 0.25rem;
                transition: all 300ms;
                outline: none;
            }
            .btn-primary:hover {
                background-color: rgba(79, 70, 229, 0.9);
            }
            .btn-primary:focus {
                box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
            }
            .btn-secondary {
                background-color: white;
                color: #374151;
                font-weight: 500;
                border: 1px solid #d1d5db;
                padding: 0.5rem 1rem;
                border-radius: 0.25rem;
                transition: all 300ms;
                outline: none;
            }
            .btn-secondary:hover {
                background-color: #f3f4f6;
            }
            .btn-secondary:focus {
                box-shadow: 0 0 0 2px #e5e7eb;
            }
            .input-field {
                width: 100%;
                padding: 0.5rem 1rem;
                border: 1px solid #d1d5db;
                border-radius: 0.375rem;
                outline: none;
                transition: all 300ms;
            }
            .input-field:focus {
                box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
                border-color: var(--primary-color, #4f46e5);
            }
            .form-label {
                display: block;
                font-size: 0.875rem;
                font-weight: 500;
                color: #374151;
                margin-bottom: 0.25rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <button id="backButton" class="text-gray-600 hover:text-primary transition-colors">
                        <i class="fa fa-arrow-left text-xl"></i>
                    </button>
                    <h1 class="text-xl font-bold text-primary">物品验证</h1>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6 card-shadow">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-primary mb-4">
                    <i class="fa fa-shield text-2xl"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-800">身份验证</h2>
                <p class="text-gray-600 mt-2">请回答关于物品的详细描述以验证您的身份</p>
            </div>

            <form id="verificationForm" class="space-y-4">
                <!-- 隐藏的物品ID和类型 -->
                <input type="hidden" id="itemId" value="">
                <input type="hidden" id="itemType" value="">

                <!-- 验证问题区域 -->
                <div id="verificationQuestions" class="space-y-6">
                    <!-- 问题1：物品颜色 -->
                    <div>
                        <label class="form-label">该物品的颜色是什么？</label>
                        <input type="text" id="colorQuestion" class="input-field" placeholder="请输入物品的颜色" required>
                    </div>

                    <!-- 问题2：物品特征 -->
                    <div>
                        <label class="form-label">该物品有哪些明显的特征或标记？</label>
                        <textarea id="featuresQuestion" class="input-field" rows="3" placeholder="请描述物品的明显特征" required></textarea>
                    </div>

                    <!-- 问题3：发现地点细节 -->
                    <div>
                        <label class="form-label">请描述发现该物品的确切位置细节（如附近的地标、具体区域等）</label>
                        <textarea id="locationDetailsQuestion" class="input-field" rows="3" placeholder="请详细描述发现位置" required></textarea>
                    </div>
                </div>

                <div class="pt-4">
                    <button type="submit" class="btn-primary w-full">
                        <i class="fa fa-check mr-2"></i>提交验证
                    </button>
                </div>
            </form>
            
            <!-- 验证结果区域 -->
            <div id="verificationResult" class="mt-6"></div>

            <div class="text-center mt-6 text-sm text-gray-500">
                <p>此验证步骤用于确保物品能够归还到真正的失主手中</p>
                <p class="mt-1">如有疑问，请联系平台客服</p>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-4 py-6 text-center text-gray-600">
            <p>© 2024 失物招领平台 - 让每一件物品都能找到回家的路</p>
        </div>
    </footer>

    <script>
        // 获取URL参数
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                id: params.get('itemId'),
                type: params.get('type')
            };
        }

        // 返回按钮功能
        document.getElementById('backButton').addEventListener('click', function() {
            // 根据类型返回对应的列表页面
            const params = getUrlParams();
            if (params.type === 'lost') {
                window.location.href = '/原型/失物招领平台_失物页面.html';
            } else {
                window.location.href = '/原型/失物招领平台_招领页面.html';
            }
        });

        // 从数据库获取物品描述信息
        async function getItemDescription(itemId, itemType) {
            try {
                // 调用后端API获取真实的物品描述 - 正确的路径格式
                const response = await fetch(`http://localhost:3000/api/${itemType}-items/${itemId}`);
                
                if (!response.ok) {
                    throw new Error(`获取物品描述失败: HTTP ${response.status}`);
                }
                
                const data = await response.json();
                return data.description || "物品描述暂不可用";
            } catch (error) {
                console.error('调用获取物品描述API失败:', error);
                // 不再使用模拟数据，直接抛出错误或返回默认描述
                throw error;
            }
        }

        // 调用外部AI生成验证问题和答案关键词
        async function generateVerificationQuestions(description) {
            // 显示加载状态
            document.getElementById('verificationQuestions').innerHTML = '<p class="text-center text-gray-500">正在生成验证问题，请稍候...</p>';
            
            try {
                // 获取URL参数
                const params = getQueryParams();
                const itemId = params.itemId || params.id;
                const itemType = params.type || 'found';
                
                // 调用后端AI API生成验证问题
                const response = await fetch(`http://localhost:3000/api/ai/questions/${itemType}/${itemId}`);
                
                if (!response.ok) {
                    throw new Error(`生成验证问题失败: HTTP ${response.status}`);
                }
                
                const result = await response.json();
                return result.data.questions || [];
            } catch (error) {
                console.error('调用AI生成问题API失败:', error);
                // 不再使用模拟数据或本地逻辑，直接抛出错误
                throw error;
            }
        }

        // 渲染验证问题
        function renderVerificationQuestions(questions) {
            const questionsContainer = document.getElementById('verificationQuestions');
            questionsContainer.innerHTML = '';
            
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                // 统一使用expectedKeywords字段
                const keywords = q.expectedKeywords || q.keywords || [];
                questionDiv.innerHTML = `
                    <label class="form-label">${index + 1}. ${q.question}</label>
                    <textarea 
                        id="question-${index}" 
                        class="input-field" 
                        rows="2" 
                        placeholder="请输入您的回答" 
                        required
                        data-keywords="${JSON.stringify(keywords)}">
                    </textarea>
                `;
                questionsContainer.appendChild(questionDiv);
            });
        }

        // 获取URL参数的函数
        function getQueryParams() {
            const params = {};
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            
            urlParams.forEach((value, key) => {
                params[key] = value;
            });
            
            return params;
        }

        // 初始化页面
        async function initPage() {
            const params = getQueryParams();
            const itemId = params.itemId || params.id; // 兼容新旧参数名
            const itemType = params.type || 'found';
            
            if (!itemId) {
                alert('缺少物品ID参数！');
                window.location.href = '/原型/失物招领平台_招领页面.html';
                return;
            }
            
            document.getElementById('itemId').value = itemId;
            document.getElementById('itemType').value = itemType;
            
            console.log('验证物品ID:', itemId, '类型:', itemType);
            
            try {
                // 1. 获取物品描述
                const description = await getItemDescription(itemId, itemType);
                
                // 2. 根据描述生成验证问题
                const verificationQuestions = await generateVerificationQuestions(description);
                
                // 3. 渲染问题到页面
                renderVerificationQuestions(verificationQuestions);
                
                // 4. 保存验证信息到localStorage
                localStorage.setItem(`verification_${itemId}`, JSON.stringify({
                    questions: verificationQuestions,
                    timestamp: new Date().getTime()
                }));
                
            } catch (error) {
                console.error('初始化验证页面失败:', error);
                alert('加载验证内容失败，请稍后再试。');
                // 根据类型返回对应的列表页面
                if (itemType === 'lost') {
                    window.location.href = '/原型/失物招领平台_失物页面.html';
                } else {
                    window.location.href = '/原型/失物招领平台_招领页面.html';
                }
            }
        }

        // 使用后端AI API验证用户回答
        async function validateAnswer(userAnswer, keywords, itemId, itemType) {
            try {
                // 调用后端验证API
                const response = await fetch(`http://localhost:3000/api/ai/validate/${itemType}/${itemId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        answer: userAnswer,
                        keywords: keywords
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`验证失败: HTTP ${response.status}`);
                }
                
                const result = await response.json();
                return result.success && result.data.isValid;
            } catch (error) {
                console.error('调用AI验证API失败:', error);
                // 不再使用本地验证逻辑，直接抛出错误
                throw error;
            }
        }

        // 显示验证结果
        function showVerificationResult(isPassed, correctCount, totalCount) {
            const resultContainer = document.getElementById('verificationResult');
            
            if (isPassed) {
                resultContainer.innerHTML = `
                    <div class="verification-success">
                        <h3>验证通过！</h3>
                        <p>您已成功通过身份验证，可以查看物品详情。</p>
                        <button id="continueButton" class="primary-button">继续</button>
                    </div>
                `;
                
                // 直接跳转到详情页面，不需要等待用户点击继续按钮
                // 但保留继续按钮以便用户手动控制跳转时机
                setTimeout(() => {
                    try {
                        const params = getQueryParams();
                        const itemId = params.itemId || params.id;
                        const itemType = params.type || 'found';
                        
                        console.log('验证通过，即将跳转到详情页:', itemId, itemType);
                        window.location.href = `/原型/失物招领平台_详情页面.html?id=${itemId}&type=${itemType}&verified=true`;
                    } catch (error) {
                        console.error('跳转详情页失败:', error);
                    }
                }, 1000); // 1秒后自动跳转
                
                // 添加继续按钮事件
                document.getElementById('continueButton').addEventListener('click', function() {
                    try {
                        const params = getQueryParams();
                        const itemId = params.itemId || params.id;
                        const itemType = params.type || 'found';
                        
                        console.log('用户点击继续，跳转到详情页:', itemId, itemType);
                        window.location.href = `/原型/失物招领平台_详情页面.html?id=${itemId}&type=${itemType}&verified=true`;
                    } catch (error) {
                        console.error('跳转详情页失败:', error);
                    }
                });
            } else {
                resultContainer.innerHTML = `
                    <div class="verification-failed">
                        <h3>验证失败</h3>
                        <p>您的回答未能通过验证，请重新尝试。</p>
                        <p>答对: ${correctCount}/${totalCount}</p>
                        <button id="retryButton" class="primary-button">重新验证</button>
                    </div>
                `;
                
                // 添加重试按钮事件
                document.getElementById('retryButton').addEventListener('click', function() {
                    console.log('用户点击重新验证，刷新页面');
                    window.location.reload();
                });
            }
        }

        // 表单提交处理
        document.getElementById('verificationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const params = getQueryParams();
            const itemId = params.itemId || params.id; // 兼容新旧参数名
            const itemType = params.type || 'found';
            
            console.log('表单提交，物品ID:', itemId, '类型:', itemType);
            
            // 从localStorage获取验证问题和答案
            const storedVerification = localStorage.getItem(`verification_${itemId}`);
            if (!storedVerification) {
                alert('验证信息丢失，请重新开始验证流程。');
                // 根据类型返回对应的列表页面
                if (itemType === 'lost') {
                    window.location.href = '/原型/失物招领平台_失物页面.html';
                } else {
                    window.location.href = '/原型/失物招领平台_招领页面.html';
                }
                return;
            }
            
            const { questions } = JSON.parse(storedVerification);
            
            // 显示加载状态
            const resultContainer = document.getElementById('verificationResult');
            resultContainer.innerHTML = '<p class="text-center text-gray-500">正在验证答案，请稍候...</p>';
            
            // 收集用户答案并验证
            let correctCount = 0;
            let totalQuestions = questions.length;
            
            // 防止totalQuestions为0导致的除零错误
            if (totalQuestions === 0) {
                resultContainer.innerHTML = '<p class="text-center text-red-500">验证问题加载失败，请刷新页面重试。</p>';
                return;
            }
            
            // 使用异步方式验证每个答案
            for (let i = 0; i < questions.length; i++) {
                const q = questions[i];
                const userAnswer = document.getElementById(`question-${i}`).value.trim();
                
                if (userAnswer) {
                    console.log(`验证问题 ${i+1}:`, q.question);
                    console.log(`用户答案:`, userAnswer);
                    console.log(`期望关键词:`, q.expectedKeywords || q.keywords);
                    
                    // 调用AI验证API
                    const isCorrect = await validateAnswer(
                        userAnswer, 
                        q.expectedKeywords || q.keywords || [], 
                        itemId, 
                        itemType
                    );
                    
                    if (isCorrect) {
                        correctCount++;
                        console.log(`问题 ${i+1} 验证通过`);
                    } else {
                        console.log(`问题 ${i+1} 验证失败`);
                    }
                }
            }
            
            // 判断验证是否通过（答对至少50%的问题）
            const isPassed = correctCount >= Math.ceil(questions.length * 0.5);
            
            console.log(`验证统计: 答对 ${correctCount}/${totalQuestions}，通过率: ${isPassed ? '通过' : '未通过'}`);
            
            if (isPassed) {
                // 验证通过，清除localStorage中的验证信息
                localStorage.removeItem(`verification_${itemId}`);
                
                // 显示成功结果
                showVerificationResult(true, correctCount, questions.length);
            } else {
                // 验证失败
                showVerificationResult(false, correctCount, questions.length);
            }
        });
        
        // 添加CSS样式
        const style = document.createElement('style');
        style.textContent = `
            /* 验证问题样式 */
            .verification-question {
                margin-bottom: 20px;
                padding: 15px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                background-color: #f9f9f9;
            }
            
            .verification-question label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #333;
            }
            
            .verification-question textarea {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
                resize: vertical;
                font-family: inherit;
            }
            
            .verification-question textarea:focus {
                outline: none;
                border-color: #4CAF50;
                box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
            }
            
            /* 验证结果样式 */
            .verification-success {
                padding: 20px;
                background-color: #e8f5e9;
                border: 1px solid #c8e6c9;
                border-radius: 8px;
                text-align: center;
                color: #2e7d32;
                margin-top: 20px;
            }
            
            .verification-failed {
                padding: 20px;
                background-color: #ffebee;
                border: 1px solid #ffcdd2;
                border-radius: 8px;
                text-align: center;
                color: #c62828;
                margin-top: 20px;
            }
            
            /* 按钮样式 */
            .primary-button {
                background-color: #4CAF50;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 4px;
                font-size: 16px;
                cursor: pointer;
                margin-top: 15px;
                transition: background-color 0.3s;
            }
            
            .primary-button:hover {
                background-color: #45a049;
            }
            
            /* 提交按钮样式 */
            #verificationForm button[type="submit"] {
                width: 100%;
                padding: 12px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                font-size: 16px;
                cursor: pointer;
                margin-top: 20px;
                transition: background-color 0.3s;
            }
            
            #verificationForm button[type="submit"]:hover {
                background-color: #45a049;
            }
            
            /* 错误消息样式 */
            .error-message {
                color: #c62828;
                text-align: center;
                padding: 10px;
            }
            
            /* 加载状态样式 */
            .loading {
                display: flex;
                justify-content: center;
                padding: 20px;
                color: #666;
            }
            
            /* 表单容器样式 */
            .verification-container {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background-color: #fff;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            /* 标题样式 */
            h2 {
                color: #333;
                text-align: center;
                margin-bottom: 30px;
            }
        `;
        document.head.appendChild(style);

        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>