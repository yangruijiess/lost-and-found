<!DOCTYPE html><html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>私信 - 拾物通</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        body {
            background-color: #f8fafc;
            font-family: 'Noto Sans SC', sans-serif;
            color: #334155;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #1e3a8a;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        .btn-secondary {
            border: 1px solid #cbd5e1;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #f1f5f9;
        }
        .tag {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        .tag-found {
            background-color: #dcfce7;
            color: #166534;
        }
        .tag-lost {
            background-color: #ffedd5;
            color: #9a3412;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .nav-link {
            position: relative;
            padding-bottom: 5px;
        }
        .nav-link.active:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: #ff7d00;
        }
        .chat-sidebar {
            border-right: 1px solid #e2e8f0;
            height: 600px; /* 使用固定高度 */
        }
        .chat-item {
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
        }
        .chat-item:hover {
            background-color: #f8fafc;
        }
        .chat-item.active {
            background-color: #eef2ff;
        }
        .chat-content {
            height: 600px; /* 使用固定高度 */
            display: flex;
            flex-direction: column;
        }
        .message-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .message-input-area {
            border-top: 1px solid #e2e8f0;
            padding: 1rem;
            background-color: white;
            position: relative;
        }
        /* 头像样式优化 */
        .avatar-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            border-radius: 50%;
            overflow: hidden;
            background-color: #f1f5f9;
            flex-shrink: 0;
            border: 2px solid white;
        }
        .avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .avatar-small {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #f1f5f9;
            border: 2px solid white;
        }
        .avatar-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            background-color: #10b981;
        }
        /* 确保相对定位容器正确 */
        .avatar-container-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }
        .message-bubble {
            max-width: 70%;
            border-radius: 18px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            word-wrap: break-word;
        }
        .message-bubble.sent {
            background-color: #3b82f6;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message-bubble.received {
            background-color: #f1f5f9;
            color: #334155;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .message-time {
            font-size: 0.75rem;
            opacity: 0.7;
            text-align: right;
            margin-top: 0.25rem;
        }
        
        .message-status {
            font-size: 0.7rem;
            margin-left: 4px;
        }
        .message-list {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            padding: 1rem;
            height: calc(100% - 100px); /* 为输入区域预留空间 */
        }
        .unread-badge {
            background-color: #ef4444;
            color: white;
            border-radius: 10px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-6 py-4 max-w-7xl">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <div class="flex items-center space-x-2">
                    <span class="iconify text-2xl text-blue-800" data-icon="mdi:hand-heart"></span>
                    <h1 class="text-xl font-bold text-blue-800">拾物通</h1>
                </div>
                
                <!-- 主导航菜单 -->
                <nav class="hidden md:flex space-x-8">
                    <a href="失物招领平台_失物页面.html" class="nav-link font-medium text-gray-600 hover:text-blue-800">失物</a>
                    <a href="失物招领平台_招领页面.html" class="nav-link font-medium text-gray-600 hover:text-blue-800">招领</a>
                    <a href="失物招领平台_发布信息页面.html" class="nav-link font-medium text-gray-600 hover:text-blue-800">发布信息</a>
                    <a href="失物招领平台_私信页面.html" class="nav-link active font-medium text-blue-800">私信</a>
                    <a href="失物招领平台_个人中心页面.html" class="nav-link font-medium text-gray-600 hover:text-blue-800">个人中心</a>
                </nav>
                
                <!-- 搜索框 -->
                <div class="hidden lg:flex items-center border border-gray-300 rounded-lg px-3 py-2 w-64">
                    <input type="text" placeholder="搜索物品或地点..." class="flex-1 focus:ring-0 border-none">
                    <span class="iconify text-gray-500" data-icon="mdi:magnify"></span>
                </div>
                
                <!-- 用户入口 -->
                <div class="flex items-center space-x-4">
                    <a href="index.html" class="btn-secondary text-sm hidden lg:block">登录/注册</a>
                    <div class="lg:hidden">
                        <span class="iconify text-2xl text-gray-700" data-icon="mdi:menu"></span>
                    </div>
                </div>
            </div>
    </header>

    <!-- 主体内容 -->
    <main class="container mx-auto px-6 py-8 max-w-7xl">
        <div class="bg-white card overflow-hidden">
            <div class="flex flex-col lg:flex-row h-auto max-h-[80vh]">
                <!-- 左侧聊天列表 -->
                <div class="chat-sidebar w-full lg:w-80 p-0">
                    <!-- 搜索框 -->
                    <div class="p-4 border-b">
                        <div class="relative">
                            <input type="text" placeholder="搜索对话..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-0">
                            <span class="iconify absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" data-icon="mdi:magnify"></span>
                        </div>
                    </div>
                    
                    <!-- 对话列表 -->
                    <div class="overflow-y-auto h-full" id="conversation-list">
                        <!-- 对话列表将通过JavaScript动态生成 -->
                        <div class="text-center text-gray-500 py-8">加载中...</div>
                    </div>
                </div>
                
                <!-- 右侧聊天内容 -->
                <div class="chat-content w-full flex flex-col">
                    <!-- 聊天头部 -->
                    <div class="p-4 border-b flex items-center justify-between">
                        <div class="flex items-center">
                            <img id="current-chat-avatar" src="https://randomuser.me/api/portraits/women/44.jpg" alt="当前聊天用户头像" class="avatar-small mr-3" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23cbd5e1%22><path d=%22M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z%22/></svg>';">
                            <div>
                                <h3 id="current-chat-name" class="font-medium">李明</h3>
                                <p id="current-chat-status" class="text-xs text-green-500 flex items-center">
                                    <span class="w-2 h-2 bg-green-500 rounded-full mr-1 inline-block"></span>
                                    在线
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button class="p-2 text-gray-500 hover:text-blue-800">
                                <span class="iconify text-lg" data-icon="mdi:phone"></span>
                            </button>
                            <button class="p-2 text-gray-500 hover:text-blue-800">
                                <span class="iconify text-lg" data-icon="mdi:video"></span>
                            </button>
                            <button class="p-2 text-gray-500 hover:text-blue-800">
                                <span class="iconify text-lg" data-icon="mdi:more-vert"></span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 聊天内容区域 -->
                    <div class="message-list flex-grow overflow-y-auto">
                        <!-- 消息列表将通过JavaScript动态生成 -->
                        <div class="text-center text-gray-500 py-12">请选择一个对话开始聊天</div>
                    </div>
                    
                    <!-- 输入区域 -->
                    <div class="message-input-area p-4 border-t" style="z-index: 10;">
                        <div class="flex space-x-3">
                            <div class="flex items-center space-x-2 text-gray-500">
                                <button class="p-2 hover:text-blue-800 hover:bg-blue-50 rounded-full">
                                    <span class="iconify" data-icon="mdi:paperclip"></span>
                                </button>
                                <button class="p-2 hover:text-blue-800 hover:bg-blue-50 rounded-full">
                                    <span class="iconify" data-icon="mdi:image"></span>
                                </button>
                                <button class="p-2 hover:text-blue-800 hover:bg-blue-50 rounded-full">
                                    <span class="iconify" data-icon="mdi:smile"></span>
                                </button>
                            </div>
                            <div class="flex-1 relative">
                                <textarea placeholder="输入消息..." class="w-full p-3 border rounded-lg resize-none focus:ring-0" rows="2"></textarea>
                            </div>
                            <button id="send-message-btn" class="btn-primary self-end">发送</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚区域 -->
    <footer class="bg-gray-100 py-10 mt-8">
        <div class="container mx-auto px-6 max-w-7xl">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <span class="iconify text-2xl text-blue-800" data-icon="mdi:hand-heart"></span>
                        <h2 class="text-xl font-bold text-blue-800">拾物通</h2>
                    </div>
                    <p class="text-gray-600 mb-4">连接失物与主人的公益平台</p>
                    <div class="flex space-x-4">
                        <a href="#" class="text-gray-600 hover:text-blue-800">
                            <span class="iconify text-xl" data-icon="mdi:wechat"></span>
                        </a>
                        <a href="#" class="text-gray-600 hover:text-blue-800">
                            <span class="iconify text-xl" data-icon="mdi:weibo"></span>
                        </a>
                        <a href="#" class="text-gray-600 hover:text-blue-800">
                            <span class="iconify text-xl" data-icon="mdi:qqchat"></span>
                        </a>
                    </div>
                </div>
                
                <div>
                    <h3 class="font-bold text-lg mb-4">快速链接</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-600 hover:text-blue-800">关于我们</a></li>
                        <li><a href="#" class="text-gray-600 hover:text-blue-800">失物认领流程</a></li>
                        <li><a href="#" class="text-gray-600 hover:text-blue-800">招领物品指南</a></li>
                        <li><a href="#" class="text-gray-600 hover:text-blue-800">联系我们</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="font-bold text-lg mb-4">帮助中心</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-600 hover:text-blue-800">常见问题</a></li>
                        <li><a href="#" class="text-gray-600 hover:text-blue-800">用户协议</a></li>
                        <li><a href="#" class="text-gray-600 hover:text-blue-800">隐私政策</a></li>
                        <li><a href="#" class="text-gray-600 hover:text-blue-800">使用指南</a></li>
                    </ul>
                </div>
                

            </div>
            
            <div class="border-t border-gray-200 mt-8 pt-6 text-center text-gray-500 text-sm">
                <p>© 2025 拾物通 失物招领平台 版权所有 京ICP备12345678号</p>
            </div>
        </div>
    </footer>

    <!-- 聊天功能 -->
    <script>
        // 当前用户信息（实际应该从登录状态获取）
        let currentUserId = 1; // 模拟当前用户ID
        let currentConversationId = null;
        let currentReceiverId = null;
        
        // 获取JWT令牌
        function getToken() {
            return localStorage.getItem('token');
        }
        
        // 格式化时间
        function formatMessageTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            let datePrefix = '';
            if (diffDays === 0) {
                datePrefix = '今天';
            } else if (diffDays === 1) {
                datePrefix = '昨天';
            } else if (diffDays < 7) {
                const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
                datePrefix = weekdays[date.getDay()];
            } else if (diffDays < 14) {
                datePrefix = '上周';
            } else if (diffDays < 21) {
                datePrefix = '两周前';
            } else {
                datePrefix = date.toLocaleDateString('zh-CN');
            }
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return { prefix: datePrefix, time: `${hours}:${minutes}` };
        }
        
        // 加载对话列表
        async function loadConversations() {
            try {
                const token = getToken();
                const response = await fetch('http://localhost:3000/api/conversations', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取对话列表失败');
                }
                
                const data = await response.json();
                const conversations = data.conversations;
                
                // 更新对话列表UI
                const conversationList = document.querySelector('.overflow-y-auto');
                conversationList.innerHTML = '';
                
                if (conversations.length === 0) {
                    conversationList.innerHTML = '<div class="p-4 text-center text-gray-500">暂无对话</div>';
                    return;
                }
                
                conversations.forEach((conversation, index) => {
                    const isActive = index === 0;
                    
                    const chatItem = document.createElement('div');
                    chatItem.className = `chat-item p-4 flex items-center ${isActive ? 'active' : ''}`;
                    chatItem.setAttribute('data-id', conversation.id);
                    chatItem.setAttribute('data-name', conversation.otherUsername);
                    chatItem.setAttribute('data-other-id', conversation.otherUserId);
                    
                    // 生成默认头像
                    const avatarColor = '#' + Math.floor(Math.random()*16777215).toString(16);
                    const initial = conversation.otherUsername.charAt(0).toUpperCase();
                    const defaultAvatar = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${avatarColor}"><text x="50%" y="50%" font-family="Arial" font-size="16" fill="white" text-anchor="middle" dy=".3em">${initial}</text></svg>`;
                    
                    chatItem.setAttribute('data-avatar', defaultAvatar);
                    chatItem.setAttribute('data-status', 'offline');
                    
                    // 计算时间显示
                    let timeDisplay = '未知时间';
                    if (conversation.lastMessageTime) {
                        const timeInfo = formatMessageTime(conversation.lastMessageTime);
                        timeDisplay = timeInfo.prefix === '今天' ? timeInfo.time : timeInfo.prefix;
                    }
                    
                    let unreadBadge = '';
                    if (conversation.unreadCount > 0) {
                        unreadBadge = `<span class="unread-badge">${conversation.unreadCount}</span>`;
                    }
                    
                    chatItem.innerHTML = `
                        <div class="avatar-container-wrapper">
                            <div class="avatar-container">
                                <img src="${defaultAvatar}" alt="${conversation.otherUsername}的头像">
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-1">
                                <h3 class="font-medium text-gray-900">${conversation.otherUsername}</h3>
                                <div class="flex items-center">
                                    <span class="text-xs text-gray-500 mr-2">${timeDisplay}</span>
                                    ${unreadBadge}
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 truncate">${conversation.lastMessage || '暂无消息'}</p>
                        </div>
                    `;
                    
                    conversationList.appendChild(chatItem);
                    
                    // 添加点击事件
                    chatItem.addEventListener('click', () => selectConversation(chatItem));
                });
                
                // 默认选中第一个对话
                if (conversations.length > 0) {
                    selectConversation(conversationList.querySelector('.chat-item'));
                }
            } catch (error) {
                console.error('加载对话列表失败:', error);
                // 显示模拟数据
                showMockConversations();
            }
        }
        
        // 显示模拟数据（当API不可用时）
        function showMockConversations() {
            const mockData = [
                { id: 1, otherUsername: '李', otherUserId: 2, lastMessage: '您好，我在平台上看到您发布的黑色钱包招领信息...', lastMessageTime: new Date(), unreadCount: 0 },
                { id: 2, otherUsername: '王', otherUserId: 3, lastMessage: '我找到了您丢失的蓝色书包', lastMessageTime: new Date(Date.now() - 86400000), unreadCount: 2 },
                { id: 3, otherUsername: '张', otherUserId: 4, lastMessage: '谢谢您，我已经收到了失物，非常感谢您的帮助！', lastMessageTime: new Date(Date.now() - 172800000), unreadCount: 0 },
                { id: 4, otherUsername: '刘', otherUserId: 5, lastMessage: '我可能看到了您丢失的物品', lastMessageTime: new Date(Date.now() - 259200000), unreadCount: 0 },
                { id: 5, otherUsername: '陈', otherUserId: 6, lastMessage: '请问您的物品有什么特征？', lastMessageTime: new Date(Date.now() - 345600000), unreadCount: 1 },
                { id: 6, otherUsername: '郑', otherUserId: 7, lastMessage: '您好，可以详细描述一下您丢失的物品吗？', lastMessageTime: new Date(Date.now() - 432000000), unreadCount: 0 }
            ];
            
            const conversationList = document.querySelector('.overflow-y-auto');
            conversationList.innerHTML = '';
            
            mockData.forEach((conversation, index) => {
                const isActive = index === 0;
                
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item p-4 flex items-center ${isActive ? 'active' : ''}`;
                chatItem.setAttribute('data-id', conversation.id);
                chatItem.setAttribute('data-name', conversation.otherUsername);
                chatItem.setAttribute('data-other-id', conversation.otherUserId);
                
                // 生成默认头像
                const avatarColor = '#' + Math.floor(Math.random()*16777215).toString(16);
                const initial = conversation.otherUsername.charAt(0).toUpperCase();
                const defaultAvatar = `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${avatarColor}"><text x="50%" y="50%" font-family="Arial" font-size="16" fill="white" text-anchor="middle" dy=".3em">${initial}</text></svg>`;
                
                chatItem.setAttribute('data-avatar', defaultAvatar);
                chatItem.setAttribute('data-status', 'offline');
                
                // 计算时间显示
                let timeDisplay = '未知时间';
                if (conversation.lastMessageTime) {
                    const timeInfo = formatMessageTime(conversation.lastMessageTime);
                    timeDisplay = timeInfo.prefix === '今天' ? timeInfo.time : timeInfo.prefix;
                }
                
                let unreadBadge = '';
                if (conversation.unreadCount > 0) {
                    unreadBadge = `<span class="unread-badge">${conversation.unreadCount}</span>`;
                }
                
                chatItem.innerHTML = `
                    <div class="avatar-container-wrapper">
                        <div class="avatar-container">
                            <img src="${defaultAvatar}" alt="${conversation.otherUsername}的头像">
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="font-medium text-gray-900">${conversation.otherUsername}</h3>
                            <div class="flex items-center">
                                <span class="text-xs text-gray-500 mr-2">${timeDisplay}</span>
                                ${unreadBadge}
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 truncate">${conversation.lastMessage || '暂无消息'}</p>
                    </div>
                `;
                
                conversationList.appendChild(chatItem);
                
                // 添加点击事件
                chatItem.addEventListener('click', () => selectConversation(chatItem, true));
            });
            
            // 默认选中第一个对话
            if (mockData.length > 0) {
                selectConversation(conversationList.querySelector('.chat-item'), true);
            }
        }
        
        // 选择对话
        async function selectConversation(chatItem, isMock = false) {
            // 停止当前的消息轮询
            stopMessagePolling();
            
            // 移除所有项的活跃状态
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            // 添加当前项的活跃状态
            chatItem.classList.add('active');
            
            // 获取当前聊天项的数据
            currentConversationId = chatItem.getAttribute('data-id');
            const name = chatItem.getAttribute('data-name');
            const avatar = chatItem.getAttribute('data-avatar');
            const status = chatItem.getAttribute('data-status');
            currentReceiverId = chatItem.getAttribute('data-other-id');
            
            // 更新聊天头部信息
            document.getElementById('current-chat-name').textContent = name;
            const avatarElement = document.getElementById('current-chat-avatar');
            avatarElement.src = avatar;
            avatarElement.className = 'avatar-small mr-3';
            
            // 更新在线状态
            const statusElement = document.getElementById('current-chat-status');
            if (status === 'online') {
                statusElement.className = 'text-xs text-green-500 flex items-center';
                statusElement.innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full mr-1 inline-block"></span>在线';
            } else {
                statusElement.className = 'text-xs text-gray-500 flex items-center';
                statusElement.innerHTML = '<span class="w-2 h-2 bg-gray-400 rounded-full mr-1 inline-block"></span>离线';
            }
            
            // 加载聊天历史
            if (isMock) {
                loadMockMessages(currentConversationId);
            } else {
                await loadMessages(currentConversationId);
            }
            
            // 移除未读消息标记（如果有）
            const unreadBadge = chatItem.querySelector('.unread-badge');
            if (unreadBadge) {
                unreadBadge.remove();
            }
            
            // 为新选中的对话启动消息轮询
            startMessagePolling();
        }
        
        // 加载聊天消息
        async function loadMessages(conversationId) {
            try {
                const token = getToken();
                const response = await fetch(`http://localhost:3000/api/conversations/${conversationId}/messages`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('获取消息历史失败');
                }
                
                const data = await response.json();
                const messages = data.messages;
                
                renderMessages(messages);
            } catch (error) {
                console.error('加载消息失败:', error);
                loadMockMessages(conversationId);
            }
        }
        
        // 加载模拟消息
        function loadMockMessages(conversationId) {
            const mockMessages = {
                1: [
                    { sender_id: 2, content: '您好，我在平台上看到您发布的黑色钱包招领信息，我想确认一下是不是我的', created_at: new Date(Date.now() - 3600000) },
                    { sender_id: 1, content: '您好，我确实捡到了一个黑色钱包，请问您能描述一下钱包的具体特征吗？比如品牌、里面有什么物品等', created_at: new Date(Date.now() - 3540000) },
                    { sender_id: 2, content: '钱包是Coach品牌的，黑色皮质，里面有我的身份证（姓名：李明）、一张工商银行信用卡、一张饭卡和200元现金', created_at: new Date(Date.now() - 3420000) },
                    { sender_id: 1, content: '描述基本符合，请问您什么时候方便来认领？我现在在图书馆二楼自习室', created_at: new Date(Date.now() - 3300000) },
                    { sender_id: 2, content: '太好了！我大约半小时后可以到图书馆，我们在二楼大厅见面可以吗？', created_at: new Date(Date.now() - 1800000) }
                ],
                2: [
                    { sender_id: 1, content: '您好，请问您发布的是蓝色书包的招领信息吗？', created_at: new Date(Date.now() - 86400000) },
                    { sender_id: 3, content: '是的，我在教学楼A栋捡到了一个蓝色书包', created_at: new Date(Date.now() - 86100000) },
                    { sender_id: 3, content: '我找到了您丢失的蓝色书包', created_at: new Date(Date.now() - 85800000) }
                ],
                3: [
                    { sender_id: 1, content: '非常感谢您捡到了我的笔记本电脑！', created_at: new Date(Date.now() - 172800000) },
                    { sender_id: 4, content: '不客气，很高兴能帮到您！', created_at: new Date(Date.now() - 172200000) },
                    { sender_id: 1, content: '谢谢您，我已经收到了失物，非常感谢您的帮助！', created_at: new Date(Date.now() - 171600000) }
                ]
            };
            
            const messages = mockMessages[conversationId] || [];
            renderMessages(messages);
        }
        
        // 渲染消息
        function renderMessages(messages) {
            const messageList = document.querySelector('.message-list');
            
            // 清空当前消息列表
            messageList.innerHTML = '';
            
            if (messages.length === 0) {
                messageList.innerHTML = '<div class="text-center text-gray-500 mt-8">暂无消息</div>';
                return;
            }
            
            // 更新最后消息计数
            lastMessageCount = messages.length;
            
            // 按日期分组消息
            const messagesByDate = {};
            messages.forEach(msg => {
                const date = new Date(msg.created_at);
                const dateKey = date.toDateString();
                
                if (!messagesByDate[dateKey]) {
                    messagesByDate[dateKey] = [];
                }
                messagesByDate[dateKey].push(msg);
            });
            
            // 遍历每个日期的消息组
            Object.keys(messagesByDate).forEach(dateKey => {
                const dateMessages = messagesByDate[dateKey];
                const firstMessageTime = formatMessageTime(dateMessages[0].created_at);
                
                // 添加日期信息
                const dateElement = document.createElement('div');
                dateElement.className = 'text-center mb-6';
                dateElement.innerHTML = `<span class="text-xs bg-gray-100 text-gray-600 py-1 px-3 rounded-full">${firstMessageTime.prefix}</span>`;
                messageList.appendChild(dateElement);
                
                // 添加消息
                dateMessages.forEach(msg => {
                    const isSent = msg.sender_id == currentUserId;
                    const timeInfo = formatMessageTime(msg.created_at);
                    
                    const messageBubble = document.createElement('div');
                    messageBubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                    messageBubble.setAttribute('data-id', msg.id || 'msg-' + Date.now());
                    
                    // 对于发送的消息，可以添加已读状态
                    let statusHtml = '';
                    if (isSent && msg.read) {
                        statusHtml = ' <span class="text-green-500 text-xs">已读</span>';
                    }
                    
                    messageBubble.innerHTML = `
                        <p>${msg.content}</p>
                        <div class="message-time">${timeInfo.time}${statusHtml}</div>
                    `;
                    
                    messageList.appendChild(messageBubble);
                });
            });
            
            // 滚动到底部
            messageList.scrollTop = messageList.scrollHeight;
        }
        
        // 发送消息
        async function sendMessage(content) {
            console.log('sendMessage函数被调用:', content);
            console.log('检查条件:', !content.trim(), !currentReceiverId, !currentConversationId);
            
            if (!content.trim() || !currentReceiverId || !currentConversationId) {
                console.log('条件不满足，返回');
                console.log('content.trim():', content.trim());
                console.log('currentReceiverId:', currentReceiverId);
                console.log('currentConversationId:', currentConversationId);
                return;
            }
            
            const trimmedContent = content.trim();
            const now = new Date();
            const timeInfo = formatMessageTime(now);
            
            // 先在界面上显示发送的消息（乐观更新）
            const messageList = document.querySelector('.message-list');
            
            // 检查是否需要添加新的日期标签
            addDateSeparatorIfNeeded(now);
            
            // 添加发送的消息
            const sentBubble = document.createElement('div');
            sentBubble.className = 'message-bubble sent';
            sentBubble.setAttribute('data-id', 'temp-' + Date.now()); // 临时ID
            sentBubble.setAttribute('data-status', 'sending');
            sentBubble.innerHTML = `
                <p>${trimmedContent}</p>
                <div class="message-time">
                    ${timeInfo.time} <span class="message-status">发送中...</span>
                </div>
            `;
            messageList.appendChild(sentBubble);
            messageList.scrollTop = messageList.scrollHeight;
            
            try {
                const token = getToken();
                const response = await fetch('http://localhost:3000/api/messages', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        receiverId: currentReceiverId,
                        content: trimmedContent
                    })
                });
                
                if (!response.ok) {
                    throw new Error('发送消息失败');
                }
                
                const result = await response.json();
                
                // 更新消息状态为已发送
                const statusElement = sentBubble.querySelector('.message-status');
                if (statusElement) {
                    statusElement.textContent = '已发送';
                    statusElement.className = 'message-status text-green-500';
                }
                sentBubble.setAttribute('data-status', 'sent');
                
                // 如果服务器返回了消息ID，更新它
                if (result.message && result.message.id) {
                    sentBubble.setAttribute('data-id', result.message.id);
                }
                
                // 更新对话列表中的最后消息
                updateConversationLastMessage(trimmedContent, now);
                
                // 启动轮询检查新消息
                startMessagePolling();
                
            } catch (error) {
                console.error('发送消息失败:', error);
                
                // 更新消息状态为发送失败
                const statusElement = sentBubble.querySelector('.message-status');
                if (statusElement) {
                    statusElement.textContent = '发送失败';
                    statusElement.className = 'message-status text-red-500 cursor-pointer hover:underline';
                    statusElement.onclick = function() {
                        // 重试发送
                        statusElement.textContent = '发送中...';
                        statusElement.className = 'message-status';
                        setTimeout(() => sendMessage(content), 500);
                    };
                }
                sentBubble.setAttribute('data-status', 'failed');
            }
        }
        
        // 添加日期分隔符（如果需要）
        function addDateSeparatorIfNeeded(date) {
            const messageList = document.querySelector('.message-list');
            const dateKey = date.toDateString();
            
            // 检查最后一个日期分隔符是否与当前日期相同
            const dateSeparators = messageList.querySelectorAll('.text-center span');
            if (dateSeparators.length > 0) {
                const lastSeparator = dateSeparators[dateSeparators.length - 1];
                const lastDatePrefix = lastSeparator.textContent.trim();
                const currentDatePrefix = formatMessageTime(date).prefix;
                
                if (lastDatePrefix === currentDatePrefix) {
                    return; // 已存在相同日期的分隔符
                }
            }
            
            // 添加新的日期分隔符
            const dateElement = document.createElement('div');
            dateElement.className = 'text-center mb-6';
            dateElement.innerHTML = `<span class="text-xs bg-gray-100 text-gray-600 py-1 px-3 rounded-full">${formatMessageTime(date).prefix}</span>`;
            messageList.appendChild(dateElement);
        }
        
        // 更新对话列表中的最后消息
        function updateConversationLastMessage(content, timestamp) {
            const conversationItem = document.querySelector(`.chat-item[data-id="${currentConversationId}"]`);
            if (conversationItem) {
                // 更新最后消息文本
                const messagePreview = conversationItem.querySelector('p');
                if (messagePreview) {
                    messagePreview.textContent = content.length > 50 ? content.substring(0, 50) + '...' : content;
                    messagePreview.className = 'text-sm text-gray-600 truncate';
                }
                
                // 更新时间
                const timeElement = conversationItem.querySelector('.text-xs.text-gray-500');
                if (timeElement) {
                    const timeInfo = formatMessageTime(timestamp);
                    timeElement.textContent = timeInfo.prefix === '今天' ? timeInfo.time : timeInfo.prefix;
                }
                
                // 移动到列表顶部
                const parent = conversationItem.parentNode;
                parent.insertBefore(conversationItem, parent.firstChild);
                
                // 移除其他项的活跃状态，保持当前项的活跃状态
                document.querySelectorAll('.chat-item').forEach(el => {
                    if (el.getAttribute('data-id') !== currentConversationId) {
                        el.classList.remove('active');
                    }
                });
                conversationItem.classList.add('active');
            }
        }
        
        // 轮询检查新消息
        let pollingInterval = null;
        let lastMessageCount = 0;
        
        function startMessagePolling() {
            // 先清除之前的轮询
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // 记录当前消息数量
            lastMessageCount = document.querySelectorAll('.message-bubble').length;
            
            // 设置新的轮询
            pollingInterval = setInterval(async () => {
                if (currentConversationId) {
                    try {
                        const token = getToken();
                        const response = await fetch(`http://localhost:3000/api/conversations/${currentConversationId}/messages`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error('获取消息失败');
                        }
                        
                        const data = await response.json();
                        const messages = data.messages;
                        
                        // 如果有新消息
                        if (messages.length > lastMessageCount) {
                            // 获取新消息
                            const newMessages = messages.slice(lastMessageCount);
                            
                            // 在界面上显示新消息
                            const messageList = document.querySelector('.message-list');
                            
                            newMessages.forEach(msg => {
                                if (msg.sender_id != currentUserId) { // 只显示接收到的新消息
                                    // 检查是否需要添加日期分隔符
                                    addDateSeparatorIfNeeded(new Date(msg.created_at));
                                    
                                    const timeInfo = formatMessageTime(msg.created_at);
                                    const messageBubble = document.createElement('div');
                                    messageBubble.className = 'message-bubble received';
                                    messageBubble.setAttribute('data-id', msg.id || 'new-' + Date.now());
                                    
                                    messageBubble.innerHTML = `
                                        <p>${msg.content}</p>
                                        <div class="message-time">${timeInfo.time}</div>
                                    `;
                                    
                                    messageList.appendChild(messageBubble);
                                }
                            });
                            
                            // 更新最后消息数量
                            lastMessageCount = messages.length;
                            
                            // 滚动到底部
                            messageList.scrollTop = messageList.scrollHeight;
                        }
                    } catch (error) {
                        console.error('轮询新消息失败:', error);
                        // 轮询出错时停止
                        stopMessagePolling();
                    }
                }
            }, 3000); // 每3秒检查一次新消息
        }
        
        function stopMessagePolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }
        
        // 发送消息按钮点击事件
        // 为发送按钮添加点击事件（使用ID选择器）
        const sendButton = document.getElementById('send-message-btn');
        const messageTextarea = document.querySelector('.message-input-area textarea');
        
        // 确保变量初始化
        if (!currentConversationId) currentConversationId = '1';
        if (!currentReceiverId) currentReceiverId = '2';
        
        if (sendButton && messageTextarea) {
            console.log('找到发送按钮和文本框');
            sendButton.addEventListener('click', function() {
                console.log('发送按钮被点击');
                const messageText = messageTextarea.value.trim();
                
                console.log('消息内容:', messageText);
                console.log('当前会话ID:', currentConversationId);
                console.log('当前接收者ID:', currentReceiverId);
                
                if (messageText && currentConversationId && currentReceiverId) {
                    // 立即设置必要的会话变量，确保发送消息时可用
                    const activeChatItem = document.querySelector('.chat-item.active') || document.querySelector('.chat-item');
                    if (activeChatItem) {
                        currentConversationId = activeChatItem.getAttribute('data-id') || '1';
                        currentReceiverId = activeChatItem.getAttribute('data-other-id') || '2';
                    }
                    
                    sendMessage(messageText);
                    messageTextarea.value = '';
                    // 重置文本框高度
                    messageTextarea.style.height = 'auto';
                    messageTextarea.style.height = Math.min(messageTextarea.scrollHeight, 120) + 'px';
                }
            });
        } else {
            console.error('未找到发送按钮或文本框');
        }
        
        // 按Enter发送消息
        document.querySelector('.message-input-area textarea').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const messageText = this.value.trim();
                if (messageText) {
                    sendMessage(messageText);
                    this.value = '';
                    // 重置文本框高度
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                }
            }
        });
        
        // 自动调整文本框高度
        document.querySelector('.message-input-area textarea').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px'; // 限制最大高度
        });
        
        // 处理URL参数并自动选择对应的对话
        function handleUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const recipientName = urlParams.get('recipient');
            const recipientId = urlParams.get('recipientId');
            
            console.log('URL参数:', { recipientName, recipientId });
            
            if (recipientId || recipientName) {
                // 尝试根据ID或名称找到对应的聊天项
                let targetChatItem = null;
                
                if (recipientId) {
                    targetChatItem = document.querySelector(`.chat-item[data-other-id="${recipientId}"]`);
                }
                
                if (!targetChatItem && recipientName) {
                    // 如果没有找到ID匹配的，尝试根据名称匹配
                    const chatItems = document.querySelectorAll('.chat-item');
                    for (let item of chatItems) {
                        const name = item.querySelector('.chat-name')?.textContent;
                        if (name && name.includes(recipientName)) {
                            targetChatItem = item;
                            break;
                        }
                    }
                }
                
                // 如果找到对应的聊天项，选择它
                if (targetChatItem) {
                    console.log('根据URL参数找到对话项，自动选择');
                    selectConversation(targetChatItem, true);
                    return true;
                } else {
                    console.log('未找到匹配的对话项');
                }
            }
            
            return false;
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 模拟用户登录（实际应该从登录状态获取）
            // 这里为了演示，使用模拟token
            if (!localStorage.getItem('token')) {
                localStorage.setItem('token', 'mock-jwt-token');
            }
            
            // 初始化时加载对话列表
            loadConversations();
            
            // 处理URL参数并自动选择对应的对话
            setTimeout(() => {
                // 首先尝试根据URL参数选择对话
                const urlHandled = handleUrlParams();
                
                // 如果URL参数处理失败，选择默认对话
                if (!urlHandled) {
                    const activeChatItem = document.querySelector('.chat-item.active') || document.querySelector('.chat-item');
                    if (activeChatItem) {
                        console.log('自动选择默认对话');
                        selectConversation(activeChatItem, true);
                        console.log('选择对话后 - currentConversationId:', currentConversationId);
                        console.log('选择对话后 - currentReceiverId:', currentReceiverId);
                    } else {
                        console.error('未找到对话项');
                    }
                }
            }, 100);
            
            // 为所有聊天项添加点击事件
            document.querySelectorAll('.chat-item').forEach(item => {
                item.addEventListener('click', function() {
                    selectConversation(this, true);
                });
            });
            
            // 页面关闭或离开时停止轮询
            window.addEventListener('beforeunload', function() {
                stopMessagePolling();
            });
        });
    </script>

</body></html>